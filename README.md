# Публикации в Telegram для проекта Dubai

Система для автоматических публикаций данных о недвижимости в Telegram-канал.

## Описание проекта

Проект состоит из скриптов для автоматической публикации различных видов анализа данных о недвижимости в Telegram-канал. Каждый скрипт отвечает за определенный тип публикации, запускаемой в определенный день недели:

1. **telegram_publisher.py** (понедельник) - Общая статистика рынка недвижимости Дубая
2. **medium_apartments_publisher.py** (вторник) - Анализ апартаментов с 1-2 спальнями
3. **price_changes_publisher.py** (среда) - Анализ изменений цен на недвижимость
4. **medium_telegram_publisher.py** (четверг) - Недвижимость среднего ценового сегмента

Планировщик `publication_scheduler.py` автоматически запускает скрипты по расписанию, определенному в конфигурационном файле `schedule_config.json`.

## Требования

- Python 3.8+
- PostgreSQL
- Ubuntu Server

## Установка и настройка

### 1. Клонирование репозитория

```bash
git clone https://github.com/yourusername/publications_in_telegram_ubuntu.git
cd publications_in_telegram_ubuntu
```

### 2. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 3. Настройка переменных окружения

Скопируйте пример файла переменных окружения и отредактируйте его:

```bash
cp example.env .env
nano .env
```

Укажите в файле `.env` следующие параметры:

- Параметры подключения к базе данных
- Токен бота Telegram и ID канала
- Хост и порт вашего приложения

### Настройка на Ubuntu сервере

При настройке на Ubuntu сервере убедитесь, что в файле `.env` указаны правильные параметры для подключения к базе данных:

```
DB_HOST=89.169.166.179
DB_PORT=5432
DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=EnPswFJWY1wa
```

**Важно:** На сервере уже существует эталонный файл `.env` в директории `/opt/wealthcompas/.env`. Если у вас есть доступ к этому файлу, можно создать символическую ссылку:

```bash
mv .env .env.backup  # сохраняем копию текущего файла
ln -s /opt/wealthcompas/.env .env
```

Однако, учтите, что в этом файле могут отсутствовать необходимые параметры для Telegram. В этом случае рекомендуется:
1. Создать собственный файл `.env` с корректными параметрами Telegram
2. Использовать те же параметры подключения к базе данных, что и в файле `/opt/wealthcompas/.env`

### 4. Настройка расписания публикаций

Расписание публикаций настраивается в файле `schedule_config.json`. По умолчанию настроены 4 публикации:

- Понедельник 9:00 - Общая статистика рынка недвижимости
- Вторник 9:00 - Анализ апартаментов с 1-2 спальнями
- Среда 9:00 - Анализ изменений цен
- Четверг 9:00 - Недвижимость среднего ценового сегмента

При необходимости вы можете изменить дни и время публикаций.

## Запуск и управление

### Запуск планировщика

Для запуска планировщика публикаций выполните:

```bash
chmod +x start_scheduler.sh
./start_scheduler.sh
```

### Остановка планировщика

Для остановки планировщика выполните:

```bash
chmod +x stop_scheduler.sh
./stop_scheduler.sh
```

### Проверка статуса

Информация о работе планировщика записывается в файл `scheduler.log`.

```bash
tail -f scheduler.log
```

### Деплой на сервере

Для удобного обновления проекта на сервере создан скрипт `deploy.sh`. Он выполняет следующие действия:
1. Останавливает работающий планировщик
2. Обновляет код из репозитория
3. Настраивает файл `.env` с учетом эталонного файла в `/opt/wealthcompas/.env`
4. Устанавливает зависимости
5. Делает скрипты исполняемыми
6. Запускает планировщик

Для выполнения деплоя:

```bash
chmod +x deploy.sh
./deploy.sh
```

### Ручной запуск скриптов

Для ручного запуска любого скрипта публикации выполните:

```bash
python3 script_name.py
```

Например:

```bash
python3 telegram_publisher.py
```

## Структура проекта

- `publication_scheduler.py` - Планировщик публикаций
- `schedule_config.json` - Конфигурация расписания публикаций
- `telegram_publisher.py` - Скрипт публикации общей статистики (понедельник)
- `medium_apartments_publisher.py` - Скрипт публикации о квартирах с 1-2 спальнями (вторник)
- `price_changes_publisher.py` - Скрипт публикации об изменениях цен (среда)
- `medium_telegram_publisher.py` - Скрипт публикации о недвижимости среднего ценового сегмента (четверг)
- `start_scheduler.sh` - Скрипт для запуска планировщика
- `stop_scheduler.sh` - Скрипт для остановки планировщика
- `requirements.txt` - Список зависимостей Python
- `example.env` - Пример файла с переменными окружения

## Отчеты и логи

Все опубликованные сообщения сохраняются в директории `reports/` с указанием даты и времени публикации.
Логи работы планировщика и скриптов записываются в файл `scheduler.log`.

## Примечания

- Для корректной работы скриптов необходим доступ к базе данных с информацией о недвижимости
- Убедитесь, что таблица `bayut_properties` содержит необходимые поля
- Для работы с изменениями цен используется таблица `price_history`; если она отсутствует, скрипт автоматически использует альтернативный подход для анализа

## Описание

Автоматизация публикаций в Telegram и другие каналы по расписанию. Проект предназначен для запуска на сервере Ubuntu.

---

## Структура проекта
- Скрипты публикаций (например, `telegram_publisher.py`, `medium_apartments_publisher.py` и др.)
- Файл расписания: `schedule_config.json`
- Пример конфигурации: `.env.example`
- Скрипт автоматизации: `scheduler.py`

---

## Быстрый старт (Ubuntu)

1. **Клонируйте репозиторий:**
   ```bash
   git clone <URL вашего репозитория>
   cd publications_in_telegram_ubuntu
   ```
2. **Установите зависимости:**
   ```bash
   pip install -r requirements.txt
   ```
3. **Проверьте наличие файла .env:**
   > Файл `.env` уже должен быть на сервере по пути `/home/enclude/publications_in_telegram_ubuntu/.env`. Копировать его не нужно!

4. **Настройте автоматический запуск публикаций:**
   - Скрипт `scheduler.py` будет запускать публикации по расписанию из `schedule_config.json`.
   - Добавьте задачу в cron:
     ```bash
     (crontab -l; echo "* * * * * cd /home/enclude/publications_in_telegram_ubuntu && /usr/bin/python3 scheduler.py >> scheduler.log 2>&1") | crontab -
     ```

---

## Пример .env (не добавляйте в git!)
См. файл `.env.example`.

---

## Автоматизация публикаций

- Расписание публикаций задаётся в `schedule_config.json`.
- Скрипт `scheduler.py` читает расписание и запускает нужные скрипты.

---

## Контакты и поддержка

Вопросы — в Issues или напрямую автору. 